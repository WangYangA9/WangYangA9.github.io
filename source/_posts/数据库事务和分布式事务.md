---
title: 数据库事务和分布式事务
date: 2020-06-27 00:57:22
tags: 
  - 数据库事务
  - 分布式事务
  - 存储
categories: 后端技术
---

## 冗余数据

* 冗余数据并不是指多余的数据，而是多分包含相同信息的数据
* 原则上来说，我们不应该存储冗余数据。一方面是造成存储空间的浪费，另一方面，保证这些数据的同步更新是一件很麻烦的事情
* 但是，在当前，存储成本相对较低，更为重要的是查询效率。大多数情况下，我们会采用空间换时间的策略，提升用户体验
* 为了保证冗余数据的统一性，就需要引入数据库事务作为保证

## 数据库事务

### ACID

* 数据库事务可以给我们ACID保证，即原子性A，一致性C，隔离性I，持久性D
* 原子性：一个事务中的多个操作，要么一起成功要么一起失败，不会有中间状态
* 一致性：对于其他事务，任何时刻读到的数据总是一致的，要么是事务执行前的状态，要么是事务执行后的状态
* 隔离性：还没有提交的事务，对于其他的事务是不可见的
* 持久性：只要事务提交成功，即使数据库发生宕机也不会改变事务的结果

### 事务的隔离级别

* ACID是一个非常严格的定义，是一个非常理想的状态
* 如果要保证严格的ACID，数据库就只能串行执行，效率就受到了限制
* 对于大多数系统来说，事务的原子性和持久性是一定要保证的，至于一致性和隔离性可以做适当牺牲来换取更高的效率
* MySQL提供了四种隔离级别

隔离界别 | 脏读 | 不可重复读 | 幻读
---|---|---|---
能读到未提交的数据RU| Y | Y | Y
能读到已提交的数据RC| N | Y | Y
可重复读 RR| N | N | Y
串行执行Serializeable | N | N | N

* RU为完全不隔离，不同事务之间可以读取到尚未提交的数据，可能出现脏读。串行执行性能最差，一般这两个都不会用
* RC和RR为常见的隔离级别，MySQL的默认隔离级别为RR
* RC和RR最重要的区别就是，是否可以重复读（原始数据）
* RC在于如果其他事务修改了当前事务用到的数据，如果在事务中再次读取，就会读到被其他事务修改后的数据，不可以读到原始的数据，为不可重复读
* RR则相反，在当前事务内，在本事务提交前，永远能读到事务开始时的数据
* 幻读是一个很少见的情况，在其他事务插入了某条数据后，本是无插入数据时可能会遇到主键重复错误，然而，RR模式下此时查询却无法查到数据，就行出现了幻觉一样

